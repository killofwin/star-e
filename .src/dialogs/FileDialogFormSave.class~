' Gambas class file

' FileDialogForm
' Форма запрашивает имя файла у пользователя давая выбор из определённого каталога
' ' 
Private CurrentPath As String ' текущий каталог

Public Sub Form_Open()
  

End

Public Function AskFileName(Optional Title As String = "Select file", Optional Path As String = "", Optional TextOK As String = "OK", Optional CancelText As String = "Cancel", Optional MaskFiles As String = "*", Optional PictureFiles As Picture = Null, Optional ArrayMaskFiles As String[] = Null, Optional ArrayPictureFiles As Picture[] = Null, Optional HiddenShow As Boolean = False, Optional EditMask As Boolean = False) As String
  ' Функция возвращает имя выбранного файла, 
  Dim r As String
  Dim OK As Boolean
  Dim a As Integer
  Dim m As Integer
  
  
  ' Установить нужные надписи
  Me.Text = Title
  ButtonOK.Text = TextOK
  ButtonCancel.Text = CancelText
  
  TextMaskFile.ReadOnly = Not EditMask
  
  'Установка масок файлов
  If ArrayMaskFiles = Null Then
    ' Если не передан массив масок файлов
    TextMaskFile.Add(GetMaskFile(MaskFiles))
  Else  
    ' Если передан массив масок
    If ArrayMaskFiles.Count > 0 Then
      ' есть маски файлов
      m = ArrayMaskFiles.Max
      For a = 0 To m
        ' добавление масок
        TextMaskFile.Add(GetMaskFile(ArrayMaskFiles[a])) 
      Next
    Endif 
  Endif
  
  
  
  
  RefreshFileList(Title, Path, TextOK, CancelText, MaskFiles, PictureFiles, ArrayMaskFiles, ArrayPictureFiles, HiddenShow, EditMask)  
  
  OK = Me.ShowModal()
  If OK = True Then
    r = CurrentPath & "/" & TextNameFile.Text & TextMaskFile.Text
  Endif
    
  
  Return r
  
End

Public Sub RefreshFileList(Optional Title As String = "Select file", Optional Path As String = "", Optional TextOK As String = "OK", Optional CancelText As String = "Cancel", Optional MaskFiles As String = "*", Optional PictureFiles As Picture = Null, Optional ArrayMaskFiles As String[] = Null, Optional ArrayPictureFiles As Picture[] = Null, Optional HiddenShow As Boolean = False, Optional EditMask As Boolean = False) '                                        
  ' Процедура показывает список файлов, принимает:
  ' Title заголовок окна, Path каталог , TextOK надпись кнопки выбоа файла , CancelText надпись кнопки отмены
  ' MaskFiles маска файла, PictureFiles картинка файла
  ' HiddenShow показывать ли файлы которые начинаються с точки
  ' ArrayMaskFiles массив масок файлов, не должны пересекаться  , ArrayPictureFiles массив картинок для каждой маски
  ' Если передано значение типов в виде массива, то параметры MaskFiles и PictureFiles игнорируються
  ' EditMask можно ли пользователю редектировать маску сохраняемого файла
  
  Dim FilesList As String[] ' массив для получаемого списка файлов
  
  Dim ArrayM As Integer
  Dim ArrayA As Integer ' переменные счётчиков для массивов
  Dim ArrayPictureM As Integer
  Dim m As Integer
  Dim a As Integer
  Dim Pic As Picture
  Dim h As Boolean ' скрытый файл
  
  ' Для того варианта когда переданно множество путей
  Dim lMultiPaths As New String[]
  Dim MultiA As Integer
  Dim MultiM As Integer
  
  'If Paths = Null Then
  '  ' Если не был передан массив с путями
  '  ' Значит его нужно создать 
  '   lMultiPaths.Add(Path) ' в качестве 0 элемента массива использовать обычный аргумент Path
  'Else
  '  ' Передан массив путей
  '  lMultiPaths = Null 
  '  lMultiPaths = Paths.Copy() ' копировать переданный массив в локальный
  '      
  'Endif
  
  
  ListFiles.Clear ' очистка списка
  
  'MultiM = lMultiPaths.Max ' Вычислить колличество путей
    
  'For MultiA = 0 To MultiM
  '  Path = lMultiPaths[MultiA] ' перебор путей по порядку    
    
    If PictureFiles = Null Then PictureFiles = PictureFile.Picture ' присвоение значения картинки если не передана
  
    
    If ArrayMaskFiles = Null Then
      ' передан не массив
      ArrayMaskFiles = New String[] ' таки создать массив
      ArrayPictureFiles = New Picture[]
      ArrayMaskFiles.Add(MaskFiles) ' присвоение маски
      ArrayPictureFiles.Add(PictureFiles) ' присвоение картинки
    Else
        'передан массив
        If ArrayPictureFiles = Null Then
          ' передали массив масок но не массив значков
          ArrayPictureFiles = New Picture[] ' таки создать массив
          ArrayPictureFiles.Add  
        Endif
    Endif
  
    If Path = "" Then Path = Application.Path ' путь обычный    
    If Mid(Path, Len(Path), 1) = "/" Then Path = Mid(Path, 2, Len(Path) - 1) ' Если на конце / то убрать
    CurrentPath = Path ' отредактированное свойство Path с убранным окончанием /
    
    If ArrayMaskFiles.Count > 0 Then
      ' В массиве есть маски
      ArrayPictureM = ArrayPictureFiles.Max ' максимальный индекс картинки
      ArrayM = ArrayMaskFiles.Max ' максимальный индекс маски
      For ArrayA = 0 To ArrayM
        ' перечисление массива масок
        
        ' Костыльное решение, но тсправляет баг из за которого "/" трактуется как ""
        If Len(Path) > 0 Then FilesList = Dir(Path, ArrayMaskFiles[ArrayA], gb.File)
        If Len(Path) = 0 Then FilesList = Dir("/", ArrayMaskFiles[ArrayA], gb.File)
            
        m = FilesList.Max
        If FilesList.Count > 0 Then
          ' в списке есть файлы
          If ArrayA <= ArrayPictureM Then
            ' Массивы совпадают, можно искать
            If ArrayPictureFiles[ArrayA] = Null Then Pic = PictureFile.Picture ' картинка на тот случай если нет картинки
            'If Not (ArrayPictureFiles[ArrayA] = Null) Then Print "OK"
            If Not (ArrayPictureFiles[ArrayA] = Null) Then Pic = ArrayPictureFiles[ArrayA]
          Endif
          If ArrayA > ArrayPictureM Then
            'список картинок меньше. Массивы не совпадают.
            Pic = PictureFile.Picture ' картинка на тот случай если нет картинки
          Endif
          For a = 0 To m
            ' добавление файлов из массива в список
            h = False
          
            If Mid(FilesList[a], 1, 1) = "." Then
              ' имя файла начинается с точки, значит файл скрытый
              h = True 
            Endif
          
            If HiddenShow Or (h = False) Then
              'Если разрешено показывать скрытые файлы или если файл не скрытый
              ListFiles.Add(Path & "/" & FilesList[a], FilesList[a], Pic, "")
            End If  
            'Print ArrayA
          Next
        Endif
      Next
    Endif
  'Next  
  ' список заполнен
  
End




Public Sub ButtonCancel_Click()
  Me.Close(False)
End
Public Sub ButtonOK_Click()
  Me.Close(True)
End
Public Sub ListFiles_DblClick()
  ButtonOK_Click()
End


Public Sub Form_Resize()
  ' Форма изменяет размеры
  FilesSplit.Height = Me.Height - ButtonHSplit.Height - (4 * 2) - HSplitTextString.Height
  HSplitTextString.Y = FilesSplit.Height + 4
  ButtonHSplit.Y = HSplitTextString.Y + HSplitTextString.Height + 4
  
  FilesSplit.Width = Me.Width
  ButtonHSplit.Width = Me.Width
  HSplitTextString.Width = Me.Width

End



Public Sub TextNameFile_Change()

  'TextMaskFile.Visible = True
  'ListFiles.Enabled = False
  
End

Public Function GetMaskFile(FileName As String) As String
  ' Функция возращает маску файла
  Dim l As Integer
  Dim a As Integer
  Dim r As String
  Dim p As Integer ' последняя в имени файла точка
  r = ""
  l = Len(FileName)
  If l > 0 Then
    For a = l To 1 Step -1
      ' просмотр с конца
       If p = 0 Then
         ' если таки результат не повторён
         If Mid(FileName, a, 1) = "." Then
           ' Точка найдена
           p = a 
           r = Mid(FileName, p)
         Endif
       Endif
       If p > 0 Then Break
    Next
  Endif
  Return r
End
Public Function GetNameFileNoMask(FileName As String) As String
  ' Функция возвращает имя файла без типа (из ololo.txt возвратит ololo)
  Dim l As Integer
  Dim a As Integer
  Dim r As String
  Dim p As Integer ' последняя в имени файла точка
  r = ""
  l = Len(FileName)
  If l > 0 Then
    For a = l To 1 Step -1
      ' просмотр с конца
       If p = 0 Then
         ' если таки результат не повторён
         If Mid(FileName, a, 1) = "." Then
           ' Точка найдена
           p = a 
           r = Mid(FileName, 1, p - 1)
         Endif
       Endif
       If p > 0 Then Break
    Next
  Endif
  Return r
End



Public Sub TextNameFile_MouseDown()
  'Print GetMaskFile(".src")
  'Print GetNameFileNoMask(".src")

End

Public Sub ListFiles_Click()
  ' Кликнули по списку файлов
  TextNameFile.Text = GetNameFileNoMask(ListFiles.Current.Text) ' имя файла
  TextMaskFile.Text = GetMaskFile(ListFiles.Current.Text) ' маска файла

End

Public Sub TextNameFile_KeyPress()

  

End
